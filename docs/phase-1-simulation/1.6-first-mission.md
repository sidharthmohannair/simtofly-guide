# 1.6 First Autonomous Mission

## What You'll Learn

Execute your first complete autonomous drone mission:

- ‚úÖ Understand waypoint mission structure
- ‚úÖ Create mission file in proper format
- ‚úÖ Load mission into SITL
- ‚úÖ Execute AUTO mode flight
- ‚úÖ Monitor mission progress
- ‚úÖ Analyze flight logs
- ‚úÖ Complete Phase 1 successfully

**Time:** 60-90 minutes

---

## Prerequisites

Before starting, you must have completed:

- ‚úÖ [1.1 Prerequisites and Setup](1.1-prerequisites.md)
- ‚úÖ [1.2 Environment Setup](1.2-environment-setup.md)
- ‚úÖ [1.3 ArduPilot SITL Installation](1.3-ardupilot-sitl.md)
- ‚úÖ [1.4 MAVProxy Command Line](1.4-mavproxy-basics.md)
- ‚úÖ [1.5 Gazebo Simulation](1.5-gazebo-simulation.md)
- ‚úÖ Can fly drone in Gazebo successfully

---

## üéØ What is a Mission?

**Mission** = Pre-planned list of commands the drone executes autonomously

**Mission commands include:**
- Takeoff to altitude
- Fly to waypoint (latitude, longitude, altitude)
- Perform action (take photo, wait, change speed)
- Return to launch
- Land

**AUTO mode:** Flight mode that executes loaded mission automatically.

**Why missions matter:**
- Real-world applications (surveying, delivery, inspection)
- Repeatable flights
- Complex patterns without manual control
- Foundation for advanced autonomy

---

## üìù Mission File Format

### QGroundControl Waypoint Format

ArduPilot uses **QGC WPL 110** format (QGroundControl Waypoint List).

**File structure:**
```
QGC WPL 110
0  1  0  16  0  0  0  0  LAT  LON  ALT  1
1  0  3  22  0.00  0.00  0.00  0.00  0.0  0.0  10.0  1
2  0  3  16  0.00  0.00  0.00  0.00  -35.36  149.16  20.0  1
3  0  3  16  0.00  0.00  0.00  0.00  -35.37  149.17  20.0  1
4  0  3  16  0.00  0.00  0.00  0.00  -35.36  149.17  20.0  1
5  0  3  20  0.00  0.00  0.00  0.00  0.0  0.0  0.0  1
```

**Header line:** `QGC WPL 110`

**Each line (waypoint) has 12 columns:**

| Column | Name | Description | Example |
|--------|------|-------------|---------|
| 1 | Index | Waypoint number | 0, 1, 2, 3... |
| 2 | Current | Home position (1) or waypoint (0) | 1 for home, 0 for others |
| 3 | Frame | Coordinate system (3 = relative altitude) | 3 |
| 4 | Command | MAVLink command ID | 16=WAYPOINT, 22=TAKEOFF, 20=LAND |
| 5-8 | Params | Command-specific parameters | Usually 0 |
| 9 | Latitude | Latitude in decimal degrees | -35.363261 |
| 10 | Longitude | Longitude in decimal degrees | 149.165237 |
| 11 | Altitude | Altitude in meters (relative to home) | 10.0, 20.0 |
| 12 | Autocontinue | Auto-continue to next waypoint (1=yes) | 1 |

---

### Common MAVLink Commands

| Command ID | Name | Purpose |
|------------|------|---------|
| 16 | NAV_WAYPOINT | Fly to waypoint and hold |
| 22 | NAV_TAKEOFF | Takeoff to altitude |
| 20 | NAV_LAND | Land at location |
| 21 | NAV_RETURN_TO_LAUNCH | Return and land at home |
| 93 | NAV_DELAY | Wait at waypoint (seconds) |

**Full list:** https://mavlink.io/en/messages/common.html

---

## üìù Create Your First Mission

### Mission Plan

Let's create a simple square pattern:
1. **Takeoff** to 10m
2. **Fly North** 30m at 20m altitude
3. **Fly East** 30m at 20m altitude
4. **Fly South** 30m (back toward start) at 20m altitude
5. **Fly West** 30m (return to start position) at 20m altitude
6. **Land** at start position

**Flight path:**
```
Start/Land
    ‚Üì
    1 (Takeoff 10m)
    ‚Üì
    2 (North 30m, alt 20m)
    ‚Üì
    3 (East 30m, alt 20m)
    ‚Üì
    4 (South 30m, alt 20m)
    ‚Üì
    5 (West 30m, alt 20m)
    ‚Üì
    6 (Land)
```

---

### Create Mission Directory
```bash
cd ~/simtofly_ws/missions
nano square_mission.txt
```

---

### Mission File Content

**Paste this exactly:**
```
QGC WPL 110
0	1	0	16	0	0	0	0	-35.363261	149.165237	584	1
1	0	3	22	0.00000000	0.00000000	0.00000000	0.00000000	0.00000000	0.00000000	10.0000000	1
2	0	3	16	0.00000000	0.00000000	0.00000000	0.00000000	-35.362991	149.165237	20.0000000	1
3	0	3	16	0.00000000	0.00000000	0.00000000	0.00000000	-35.362991	149.165507	20.0000000	1
4	0	3	16	0.00000000	0.00000000	0.00000000	0.00000000	-35.363261	149.165507	20.0000000	1
5	0	3	16	0.00000000	0.00000000	0.00000000	0.00000000	-35.363261	149.165237	20.0000000	1
6	0	3	20	0.00000000	0.00000000	0.00000000	0.00000000	0.00000000	0.00000000	0.0000000	1
```

**Save and exit:** Ctrl+X, then Y, then Enter

---

### Understanding the Mission File

**Line 0 (Home position):**
```
0  1  0  16  0  0  0  0  -35.363261  149.165237  584  1
```
- Index 0, Current=1 (home), Command 16 (waypoint)
- Lat/Lon: Default SITL location (Australia)
- Alt: 584m MSL (mean sea level)

**Line 1 (Takeoff):**
```
1  0  3  22  0  0  0  0  0  0  10.0  1
```
- Command 22 (TAKEOFF)
- Altitude: 10m (relative to home)

**Lines 2-5 (Waypoints):**
```
2  0  3  16  0  0  0  0  -35.362991  149.165237  20.0  1
```
- Command 16 (WAYPOINT)
- Each corner of square
- Altitude: 20m (relative)

**Line 6 (Land):**
```
6  0  3  20  0  0  0  0  0  0  0  1
```
- Command 20 (LAND)
- Returns to home and lands

---

## üöÅ Execute Mission in SITL (No Gazebo)

### Launch SITL

**Terminal 1:**
```bash
cd ~/simtofly_ws/ardupilot/ardupilot/ArduCopter
sim_vehicle.py -v ArduCopter --map --console
```

**Wait for:** `STABILIZE>` prompt and map window to open.

---

### Load Mission File

At MAVProxy prompt:
```bash
wp load ~/simtofly_ws/missions/square_mission.txt
```

**Expected output:**
```
Loaded 7 waypoints from ~/simtofly_ws/missions/square_mission.txt
```

‚úÖ **Success:** Mission loaded (7 items: home + 6 commands)

---

### Verify Mission Loaded
```bash
wp list
```

**Expected output:**
```
0  HOME(-35.363261, 149.165237, 584.00)
1  TAKEOFF(0.000000, 0.000000, 10.00)
2  WAYPOINT(-35.362991, 149.165237, 20.00)
3  WAYPOINT(-35.362991, 149.165507, 20.00)
4  WAYPOINT(-35.363261, 149.165507, 20.00)
5  WAYPOINT(-35.363261, 149.165237, 20.00)
6  LAND(0.000000, 0.000000, 0.00)
```

‚úÖ **Success:** All waypoints listed correctly

**Map window:** Should show waypoint markers connected by lines.

---

### Arm and Start Mission

**Important:** Once you arm, mission starts immediately in AUTO mode.

**Arm the vehicle:**
```bash
arm throttle
```

**Switch to AUTO mode:**
```bash
mode AUTO
```

**What happens:**
1. Motors spin up
2. Drone takes off to 10m
3. Climbs to 20m
4. Flies to each waypoint in sequence
5. Returns to start position
6. Descends and lands
7. Automatically disarms

**This takes:** 2-3 minutes total.

---

### Monitor Mission Progress

**Watch console window:**
- Current waypoint number
- Altitude climbing/descending
- Distance to next waypoint

**Watch map window:**
- Drone icon moving
- Following waypoint path
- Position updating in real-time

**MAVProxy prompt shows:**
```
AUTO> WP: 2
AUTO> WP: 3
AUTO> WP: 4
...
```

‚úÖ **Success:** Mission completes, drone lands and disarms

---

## üéÆ Execute Mission in Gazebo

### Launch Gazebo

**Terminal 1:**
```bash
gz sim -v4 -r iris_runway.sdf
```

**Wait for:** Gazebo window and drone to load.

---

### Launch SITL

**Terminal 2:**
```bash
cd ~/simtofly_ws/ardupilot/ardupilot/ArduCopter
sim_vehicle.py -v ArduCopter -f gazebo-iris --model JSON --map --console
```

**Wait for:** Connection established, `STABILIZE>` prompt.

---

### Load and Execute Mission

**In Terminal 2 (SITL prompt):**
```bash
wp load ~/simtofly_ws/missions/square_mission.txt
wp list
arm throttle
mode AUTO
```

**Watch in Gazebo:**
- Propellers spin
- Drone lifts off
- Flies square pattern in 3D
- Returns and lands

**Much more impressive in 3D visualization!**

‚úÖ **Success:** Complete autonomous mission in Gazebo

---

## üìä Understanding Mission Behavior

### Mission States

**Pre-flight:**
- Mission loaded but not executing
- Can review with `wp list`
- Can clear with `wp clear`

**During mission (AUTO mode):**
- Executing waypoints sequentially
- Current waypoint shown in console
- Can pause: `mode LOITER`
- Can resume: `mode AUTO` (continues from current waypoint)

**Mission complete:**
- Lands at final waypoint
- Automatically disarms
- Mode stays AUTO

---

### Modifying Mission Mid-Flight

**Pause mission:**
```bash
mode LOITER
```
Drone holds position.

**Resume mission:**
```bash
mode AUTO
```
Continues to next waypoint.

**Abort mission (emergency):**
```bash
mode RTL
```
Returns to home immediately.

**Land immediately:**
```bash
mode LAND
```
Descends and lands at current position.

---

## üõ†Ô∏è Create Custom Mission

### Using Your Location

**Find your coordinates:**
- Google Maps: Right-click location ‚Üí Click coordinates to copy
- Format: Latitude, Longitude (e.g., 37.7749, -122.4194)

---

### Mission Template

Create `~/simtofly_ws/missions/custom_mission.txt`:
```
QGC WPL 110
0	1	0	16	0	0	0	0	YOUR_LAT	YOUR_LON	YOUR_ALT	1
1	0	3	22	0	0	0	0	0	0	10.0	1
2	0	3	16	0	0	0	0	WAYPOINT1_LAT	WAYPOINT1_LON	15.0	1
3	0	3	16	0	0	0	0	WAYPOINT2_LAT	WAYPOINT2_LON	15.0	1
4	0	3	20	0	0	0	0	0	0	0	1
```

**Replace:**
- `YOUR_LAT`, `YOUR_LON` ‚Äî Your home position
- `YOUR_ALT` ‚Äî Your altitude MSL (check Google Earth)
- `WAYPOINT1_LAT`, `WAYPOINT1_LON` ‚Äî First waypoint
- `WAYPOINT2_LAT`, `WAYPOINT2_LON` ‚Äî Second waypoint

---

### Coordinate Math (Approximate)

**At equator (rough estimates):**
- 1¬∞ latitude ‚âà 111 km
- 1¬∞ longitude ‚âà 111 km

**For small distances:**
- 0.0001¬∞ ‚âà 11 meters
- 0.001¬∞ ‚âà 111 meters

**Example: Move 50m North from start:**
```
Original Lat: -35.363261
Add 0.00045: -35.362811  (‚âà50m North)
```

**Better tool:** Use mission planner software or online calculators.

---

## üìà Analyzing Flight Logs

### Where Logs Are Saved

SITL saves logs automatically:
```bash
cd ~/simtofly_ws/ardupilot/ardupilot/ArduCopter/logs
ls -lt
```

**Expected output:**
```
00000001.BIN
00000002.BIN
...
```

**Latest log:** Highest number.

---

### View Log Summary
```bash
cd ~/simtofly_ws/ardupilot/ardupilot/ArduCopter/logs
mavlogdump.py 00000001.BIN | less
```

**Shows:** All telemetry data (GPS, attitude, commands, etc.)

**Navigate:**
- Space: Next page
- q: Quit

---

### Extract Mission Data

**Get all waypoint changes:**
```bash
mavlogdump.py 00000001.BIN | grep "MISSION"
```

**Get all mode changes:**
```bash
mavlogdump.py 00000001.BIN | grep "MODE"
```

**Get GPS positions:**
```bash
mavlogdump.py 00000001.BIN | grep "GPS"
```

---

### Advanced: Log Analysis (Optional)

**For detailed analysis, use Mission Planner (Windows) or MAVExplorer (Linux):**
```bash
pip3 install --user MAVProxy
MAVExplorer.py ~/simtofly_ws/ardupilot/ardupilot/ArduCopter/logs/00000001.BIN
```

Opens graphical log analyzer.

**We'll cover this more in Phase 2.**

---

## üéì Mission Best Practices

### Safety Guidelines

**Always:**

- ‚úÖ Test missions in SITL before real hardware
- ‚úÖ Include takeoff command as first action
- ‚úÖ Include land or RTL as last command
- ‚úÖ Keep waypoints within safe distance
- ‚úÖ Check altitude limits (not too high)

**Never:**

- ‚ùå Skip home position (line 0)
- ‚ùå Use absolute altitude without understanding MSL
- ‚ùå Create waypoints too close together (minimum ~5m)
- ‚ùå Forget autocontinue flag (missions won't progress)

---

### Mission Design Tips

**Start simple:**
- 3-5 waypoints maximum
- Single altitude throughout
- Familiar area

**Progress to complex:**
- Multiple altitudes
- Actions at waypoints (delay, change speed)
- Survey patterns (grid, spiral)

**Test incrementally:**
- Fly each waypoint manually first
- Then convert to mission
- Test in SITL
- Finally test on real hardware (Phase 4)

---

## üìã Phase 1 Completion Checklist

**Before moving to Phase 2, verify you can:**

- [ ] ‚úÖ Launch SITL from command line
- [ ] ‚úÖ Control drone with MAVProxy commands
- [ ] ‚úÖ Launch Gazebo with drone model
- [ ] ‚úÖ Connect SITL to Gazebo
- [ ] ‚úÖ Arm, takeoff, navigate, and land in SITL
- [ ] ‚úÖ Fly complete mission in Gazebo
- [ ] ‚úÖ Create custom mission file
- [ ] ‚úÖ Load mission and execute in AUTO mode
- [ ] ‚úÖ Monitor mission progress via map and console
- [ ] ‚úÖ Analyze basic flight logs
- [ ] ‚úÖ Understand mission file format
- [ ] ‚úÖ Troubleshoot common issues

**All checked?** Congratulations! Phase 1 complete! üéâ

---

## üéØ What You Accomplished in Phase 1

**Simulation Environment:**

- ‚úÖ Set up complete Ubuntu development environment
- ‚úÖ Installed ArduPilot SITL simulator
- ‚úÖ Configured Gazebo Harmonic 3D simulation
- ‚úÖ Built ArduPilot Gazebo plugin from source

**Drone Control:**

- ‚úÖ Mastered MAVProxy command-line control
- ‚úÖ Understood flight modes and their purposes
- ‚úÖ Performed manual flights (arm, takeoff, navigate, land)
- ‚úÖ Monitored telemetry data in real-time

**Autonomous Flight:**

- ‚úÖ Created waypoint mission files
- ‚úÖ Loaded and executed autonomous missions
- ‚úÖ Completed full square pattern mission
- ‚úÖ Analyzed flight logs

**Foundation Built:**

- ‚úÖ Safe testing environment (no hardware risk)
- ‚úÖ Understanding of ArduPilot fundamentals
- ‚úÖ Ready for ROS2 integration (Phase 2)

---

## üöÄ What's Next: Phase 2 - ROS2 Integration

**Coming in Phase 2:**
- Install ROS2 Humble
- Setup MAVROS (MAVLink ‚Üî ROS2 bridge)
- Create ROS2 nodes for drone control
- Subscribe to telemetry topics
- Publish control commands
- Execute missions via ROS2
- Visualize data in RViz

**Why ROS2?**
- More flexible than MAVProxy
- Industry-standard robotics framework
- Integrate sensors (cameras, lidar)
- Advanced autonomy algorithms
- Multi-robot systems

---

## ‚ùì Common Questions

### Q: Can I create missions with a GUI instead of text files?

**A:** Yes! Use these tools:
- **Mission Planner** (Windows, most popular)
- **QGroundControl** (Cross-platform)
- **APM Planner 2** (Cross-platform)

They all export to same .txt format we use here.

---

### Q: What's the maximum mission size?

**A:** ArduPilot supports up to 700+ waypoints, but practical limits:
- SITL: Unlimited (memory constrained)
- Real hardware: ~100-200 waypoints typical
- Depends on flight controller memory

---

### Q: Can I change mission mid-flight?

**A:** Not easily. Better to:
- Pause mission (mode LOITER)
- Manually control to new area
- Resume or load new mission

**In Phase 2 with ROS2:** Dynamic mission updates are easier.

---

### Q: Why does my mission skip waypoints?

**Possible causes:**
1. Autocontinue flag = 0 (should be 1)
2. Waypoint acceptance radius too large
3. Mission file syntax error

**Check:** `wp list` shows all waypoints correctly.

---

### Q: How do I add camera trigger at waypoint?

**A:** Use DO_SET_CAM_TRIGG_DIST command (ID 206):
```
3  0  3  206  10  0  0  0  0  0  0  1
```
Triggers camera every 10 meters.

**More on this:** ArduPilot camera trigger documentation.

---

## üêõ Troubleshooting

### Mission won't load - "Failed to load waypoints"

**Cause:** File format error

**Solution:**
1. Check header line: `QGC WPL 110` (exact text)
2. Verify 12 columns per line (tab or space separated)
3. No extra blank lines
4. Home position (line 0) has Current=1

---

### Mission loads but drone doesn't move

**Cause:** Not in AUTO mode or not armed

**Solution:**
```bash
arm throttle
mode AUTO
```
In this exact order.

---

### Drone flies to wrong location

**Cause:** Incorrect coordinates in mission file

**Solution:**
- Verify latitude/longitude are in decimal degrees (not DMS)
- Check sign (negative for South/West)
- Verify altitude is relative (Frame=3), not absolute

---

### Mission starts but immediately lands

**Cause:** No takeoff command or wrong order

**Solution:**
- Line 1 must be Command 22 (TAKEOFF)
- Takeoff must come before waypoints
- Check altitude > 0

---

### Drone hovers at waypoint and doesn't continue

**Cause:** Autocontinue flag = 0

**Solution:**
- Last column of each line should be `1`
- Change `0` to `1` in mission file
- Reload mission

---

### "No GPS lock" in SITL

**Cause:** Rare in SITL, GPS initializes instantly

**Solution:**
- Wait 5 seconds after SITL launch
- Check console shows GPS: 3D Fix
- Restart SITL if issue persists

---

## üìö Additional Resources

**ArduPilot Documentation:**
- Mission Commands: https://ardupilot.org/copter/docs/common-mavlink-mission-command-messages-mav_cmd.html
- Mission Planning: https://ardupilot.org/copter/docs/common-mission-planning.html
- AUTO Mode: https://ardupilot.org/copter/docs/auto-mode.html

**MAVLink Protocol:**
- Command Reference: https://mavlink.io/en/messages/common.html
- Mission Protocol: https://mavlink.io/en/services/mission.html

**Tools:**
- QGroundControl: http://qgroundcontrol.com/
- Mission Planner: https://ardupilot.org/planner/
- MAVProxy Documentation: https://ardupilot.org/mavproxy/

---

## üéâ Congratulations on Completing Phase 1!

You've built a solid foundation in drone simulation and autonomous flight. You now understand:
- ArduPilot SITL simulator
- Gazebo 3D visualization
- MAVProxy control
- Waypoint missions
- Autonomous flight execution

**You're ready for Phase 2: ROS2 Integration**

Take a break, review what you've learned, and when ready, continue your journey!

---

## üì¢ Share Your Success

**Completed Phase 1?** We'd love to hear about it!

- Star the repository: https://github.com/simtofly/simtofly-guide
- Share your experience in Discussions
- Help others in Issues section
- Tweet with #SimToFly

**Your feedback helps improve this tutorial for everyone!**

---

[‚Üê Back: 1.5 Gazebo Simulation](1.5-gazebo-simulation.md) | [Next: Phase 2 Overview ‚Üí](../phase-2-ros2/README.md)

---

<div align="center">

**üéä Phase 1 Complete! üéä**

*You've mastered simulation. Now let's integrate ROS2.*

[Continue to Phase 2 ‚Üí](../phase-2-ros2/README.md)

</div>
